---
layout: post
title: 【编码】通用编码约定
categories: coding
date: 2019-07-17 11:48:18 +0800
---
# 前言
> 警告: 如果已经存在编码风格，请遵守原有编码风格。

编码风格的意义在于:
- 降低软件管理成本：软件的维护，基本以阅读代码为主
- 提升软件质量：软件同行审查主要检测代码缺陷。代码风格一致可让同行更易接纳、理解、吸收，提高缺陷审查过程效率。
- 降低软件复杂度：最小化代码复杂度的方式是——直接，而非高度抽象。这会产生容易阅读和遵循的最优代码，代码越复杂，越难找到隐藏错误。
- 易于重构：重构活动是软件维护行为，以修改代码来改善可读性和结构，不改变软件现有行为的改变，可视为重构。常见重构包括：改善变量名、函数名、移动整个类或分解大方法等。
- 任务自动化：典型的如通过注释来生成文档。

# 通用编码风格
- 简洁、清晰
- 简单、直接
## 空格和缩进
主要目的：代码清晰、整洁、能快速阅读。
- 4个空格大小的tab（即缩进采用4个空格，而非一个tab）
- 代码块开始标记`{`不单独放置在单行
```
  if (a == b) {
      foo();
  }
```
- 超过110字符长度单行，需要分行
```c
  int result = reallyLongFunctionOne() + reallyLongFunctionTwo() + 
          reallyLongFunctionThree() + reallyLongFunctionFour();
  
  int result2 = reallyLongFunction(parameterOne, parameterTwo, parameterThree,
          parameterFour, parameterFive, parameterSix);
```
- 表达式操作符与操作数之间添加空格
```c
  int x = (a + b) * c / d + foo();
```

- 函数之间，添加空行
```c
  void foo() {
      ...
  }
  
  // 空一行
  void bar() {
      ...
  }
```

## 命名与变量

* 变量名应具描述性，类似`firstName`或`homeworkScore`。
* 类型名`LikeThis`，常量名`LIKE_THIS`，函数名建议`like_this`，但也可以`likeThis`。
* 私有成员函数/变量，前缀`_`,`_likeThis` & `_like_this`
* 定义变量应尽可能近。如只在if表达式中用到的变量，最好放在if中，而不是其外。
* 一般函数中**避免**使用魔数，使用有意义的名称替代。
* **避免**使用可修改的全局变量。全局变量应只读。
* 函数名字要简洁、清晰，言简意赅。
* 文件名方式：`some-file`,`some.file`,`some_file`或`somefile`。
* 使用缩写的名称，即地写下注释，写明其全称。使用常用、既有的缩写方式。
* 全局变量前缀`g_`或`$`。   

## 语句与表达式
- for多用于已知循环次，while多用于未知循环次。
- 在循环中，*尽可能*不使用`break`和`continue`。采用替代写法。
- 避免多余和不必要的分支判断
- 采用变量置后的左值判断方式
  ``` c++
  // good
  if (42 == a) {}  // 变量置后可避免手误少写=

  // bad
  if (a = 42) {} // 变量置前，此表达式永远为真

  ```
- 对于if,while,for等语句，单行表达式使用大括号包裹。
  ``` c++
  if (42 == a) {
    puts("Life");
  }
  puts("Yes");

  // 如下写法常出错
  if (42 == a) 
    puts("Life");
    puts("Yes");
  ```
- 嵌套表达式的写法不要超过4层，否则考虑重构它。
- 使用`(x)`与`(!x)`判断对象

## 冗余
- 如果重复相同的代码多次，找到方法删除冗余代码，使其只有一次。例如，可放入辅助函数。如果重复的代码几乎但不完全相同，尝试让辅助函数以参数表示不同部分。
- 将公共代码移出if/else语句，以避免重复
- 如果单个函数很长（>50行），可将其分成更小的子函数。如果函数功能用`和`来描述，则考虑分解为多个子函数。

## 效率
- 将调用结果放在中间变量中，以减少再次调用消耗。
- 代码尽可能保持自解释，自解释不了，就要详细注释
- 尽可能使用前置声明。特别在C++中，使用前置声明类，可避免导入包含文件
- 用`TODO`, `FIXME`, `!!!`,`???`,`HACK`,`REVIEW`标记有问题的代码
- 多使用`Assert`和`Log`等，进行代码健壮性处理。
- 对于函数和类，在注释中写明其用法和注意事项，最好能给出例子。

## 功能和程序设计
- 传入的参数，尽量保持不变。
- 复制对象（参数），传引用或指针。（对于动态语言，通常是引用）
- 返回复杂对象时，使用返回参数引用形式。
  ```c++
  // good 
  void read_file（string filename，Vector<string>& v）{
       //在v中放入一些数据
      ...
  }
  ```
- 使用字段存储对象的重要数据，但不存储仅在单个函数使用的临时变量。
- 把与概念不相关的功能，设为辅助函数或分拆至辅助模块。
- 当使用异常和RTTI、类型转换时，要注意了

  

# C/C++特定
使用C/C++主要考虑的是性能、移植性。性能是其主要特点。但C/C++语言本身对编码人员素质要求较高，否则极易发生致命错误（内存泄漏、非法访问等）。C/C++也是嵌入式的首选语言。因此，有以下几个基本规则：
- 使用所有编译器都支持的特性。C98
- 使用带位后缀的基本数据：`u8`,`i8`,`u16`,`i16`,`u32`,`i32`,`u64`,`i64`，`f32`,`f64`。
- 尽可能避免类型转换（只在指针层面类型转换）
- 有限使用template。template会带来编译时长和代码大小的增加。
- 不要使用typeof,typeid等特性
- 不要使用异常
- 不要使用std::iostream
- 资源函数（malloc，open）等，都要有配对的函数调用（free，close）。
- 资源所有者自己管理，外部不可修改或释放此资源。
- 代码块中的注释，统一采用行尾后置C式注释（即`/* */`)。
- 类前缀`F`,接口前缀`I`,结构体前缀`S`，枚举前缀`E`，命名空间前缀`N`。
- typedef后缀`_t`，函数指针后缀`f`
- 全局变量前缀`g_`，静态变量前缀`s_`，成员变量前缀`m_`,静态成员变量前缀为`sm_`。
- 如果是C语言模拟C++，依循如下规则：
  ``` C
  typedef struct FEntityTag {
    u64 id;
    char* name;

    void(*move)(Vec3 pos);
  }FEntity;

  u8 FEntity_length() {return len;}

  typedef struct FPlayerTag {
    FEntity   super;

    i8   hp;
  }FPlayer;

  i8 FPlayer_setHp(i8 n) { hp = n;}

  static void FPlayer_move(Vec3 pos) {...}

  FPlayer a;
  a.move = FPlayer_move;

  ```
- 使用union模拟复用可变数据。