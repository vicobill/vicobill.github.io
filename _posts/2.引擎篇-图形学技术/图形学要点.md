# 图形学要点

## 矢量：

矢量用途：物体速度，加速度，摄像机观察方向，刚体受力等。

| 运算                               | 用途或意义                                                   |
| ---------------------------------- | ------------------------------------------------------------ |
| 加法：V + U                        | 计算合力或速度分量的叠加                                     |
| 减法：V - U                        | 计算两点距离                                                 |
| 数乘：n * V                        | 缩放                                                         |
| 点乘：V · U                        | 计算矢量之间夹角。=0 垂直，>0 小于90度 <0 大于90度.V · U = v~x~ * u~x~ + v~y~ * u~y~ + v~z~ * u~z~ = \|V\|\|U\|cosθ |
| 叉乘：V x U                        | 计算与矢量互相垂直的第三个矢量，大小为原矢量大小之间的乘积乘以sinθ。叉乘不满足交换律。v x u = w = (v~y~ * u~z~ - v~z~ * u~y~, <br />        v~z~ * u~x~ - v~x~ * u~y~， <br />        v~x~ * u~y~ - v~y~ * u~x~)<br /><br />w 与v,u互相垂直,X x Y = Z 即第三个轴\|w\| = \|V\|\|U\|sinθ |
| 线性插值，Lerp，平滑阻尼SmoothDamp | 线性插值，实现缓动效果。V(t) = V~1~ + t * (V~2~ - V~1~)：    |
| 球面差值：Slerp                    | 通常用于旋转四元数之间的线性差值。V(t) = k(t) * (V~1~ + t * (V~2~ - V~1~))：其中，k(t) = \|V~1~\| / \|V1 + t * (V~2~ - V~1~\| |
| \|V\|求模运算                      | 取矢量的大小 \|V\| = √x^2^+ y^2^                             |
| 归一化：Normalize                  | 将矢量的大小转换成单位大小，但方向不变。<br />N(V) = (x/\|V\|, y/\|V\|); |
| 投影：Project                      | 取一个矢量V在另外一个矢量上的投影。                          |
| 反射：Reflect                      | 根据入射方向和法线，计算反射方向。                           |

2D空间矢量可表示为3D空间矢量：(x,y,0) 或4D空间矢量：(x,y,0,0);



## 旋转

### 欧拉角

欧拉角通过Yaw(偏航角,左右摇摆),Pitch(倾斜角，上下俯仰),Roll(自旋角)。欧拉角是有顺序的旋转变换。

### 万向节死锁

@see [参考无人机欧拉角万向节死锁](http://www.cnblogs.com/driftingclouds/p/6540222.html)![示意图：](E:\dev-doc\comm\4039616-d6094d83ac541d79.gif)

因为欧拉角是有顺序的，当沿Pitch旋转为±90°时，Yaw和Roll均不会产生变化，此时Yaw轴和Roll轴会锁死，即共用一个轴面。此时，再进行Roll时，Yaw和Pitch会同时变化（例如陀螺仪）。

从几何变换上说，按照顺序的(x,90,z) 也可按照顺序的(x-z,90,0)来得到。即，此种情况下，所有按z轴的旋转，都可使用按x轴旋转得到（结果不唯一）。此时，x与z意义相同，意味着少了一个轴的自由度。

在Unity中，将Transform的Rotation的x设置为90，此时再沿着Y轴旋转，会呈现出万向锁。

万向节死锁的问题，根源是欧拉角的定义中，顺序变换得到的结果并非唯一的，当结果是多个时，会造成自由度的缺失，形成“死锁”。



### 四元数

@see [理解四元数](https://www.cnblogs.com/ne-zha/p/7302543.html)

为了解决欧拉角的万向节死锁问题，引入四元数。四元数由i,j,k,l四个数组成，i^2 = j^2 = k^2 = ijk = -1; i^0 = j^0=k^0 = 1。i,j,k是虚数。一般四元数可表示为a + bk + cj + di组成，a,b,c,d是实数。ij = k,ji=-k,jk=i,kj=-i, ki=j,ik=-j.

四元数满足乘法结合律，满足加法交换律和结合律。

i,j,k本身的几何意义可以理解为一种旋转，其中i旋转表示绕Z轴旋转，j表示绕Y轴旋转，k表示绕X轴旋转。i,j,k分别是4D空间的单位向量。

四元数是使用纯量和向量结合表示的：a+`v` 。四元数在表示3D空间旋转时，每个分量都是被`处理`过的轴和角。

``` ruby
# theta表示旋转角度,v表示原始矢量，q是旋转四元组
q.w = cos(theta/2)
q.x = v.x * sin(theta/2)
q.y = v.y * sin(theta/2)
q.z = v.z * sin(theta/2)
```

四元数是四维空间的存在，可以很方便地进行归一化，又可方便地得到轴、角这样用于3D图像的信息数据。

用四元数旋转矢量：给定矢量`v`,旋转单位为四元数q，则首先将v扩展为四维空间值：(x,y,z,0)，如果同(x,y)可以扩展为3D空间的(x,y,0)一样。四元数使用第四维轴辅助运算，所以对于所有的四元数计算，都需要采用q·v·q^-1的形式=> q·v会得到一个4D空间矢量，此时必须要乘以q^-1，从4D空间矢量转换成3D空间矢量。

#### 复数：

x^2 + 1 = 0; => x^2 = -1 即复数。所以仅仅是x^2 = -1时才是复数。

对于复数，通常使用q = a + bi;的形式，i为虚数。

使用笛卡尔坐标系模拟实数(x)和虚数(y)坐标,随机取点：p = 2 + i; => x = 2,y = i; 给一个复数乘以i，则表示在复数平面旋转了90°。

> p * i = (2 + i)i = 2i +i2 = -1 + 2i = q;

> q * i = (-1 + 2i)i = -2 -i = r;

> r * i = (-i - 2)i  = 1 - 2i = s;

>  s * i = (-1 - 2i)i = i + 2 = t = p; 



#### 复数表面的旋转：

对于复数平面的任意角度旋转，只需要定义下面复数：

> q = cosθ + sinθi;

任意复数乘以q：

> p = a + bi;
>
> p*q = (a + bi)(cosθ + sinθi)
>
> ​        = a* cosθ + a * sinθi + b*cosθi + b * sinθi^2
>
> ​	= a * cosθ - b * sinθ + (a * sinθ + b * cosθ)i
>
> 可写成矩阵模式：
>
> ​	= | cosθ		-sinθ| |a 	-b| 
>
> ​	    | sinθ 	cosθ| |b 	a|
>
> 这是在复数平面绕原点逆时针旋转任意点的方法。
>
> 这里需要注意：cosθ = cos(0+θ) = cos0 * cosθ - sin0 * sinθ

由于i^2 = j^2 = k^2 = -1; ij = k, jk = i, ki = j; ji = -k, kj = -i; ik = -j;很像笛卡尔轴叉乘关系：X x Y = Z, Y x X = -Z;所以四元数的一般形式为：

> q = s + xi + yj + zk;

通常旋转使用单位向量。

对于四元数而言，q = (w,v); w 表示实部，v表示虚部，可使用：(xi + yj + zk)来表示。其中，i,j,k也可扩展为四元数（0,i),(0,j),(0,k)。



#### 再谈四元数

对于2D空间(x,y)来说，可扩展至3D空间(x,y,0)，如果设：i,j,k都是3D空间中互相垂直的单位向量，(x,y) 可表示成： (x * i ,y * j , 0 * k);即可表示为实际存在的坐标v和并不实际存在的坐标w：(v, w),即复数中的实部和虚部：可表示为 v + wi;

此时两个2D矢量叉乘：(x1,y1) x (x2,y2) => (x1 * i,)



#### 常用四元数操作：

四元数在图形学中，通常表示旋转量。四元数本身又表示4D空间坐标矢量。

| 操作或值       | 用途或意义                         |
| -------------- | ---------------------------------- |
| identity       | 单位四元数：(0,0,0,1)              |
| Angle          | 获取两个四元数旋转之间的角度值     |
| AngleAxis      | 构造绕轴旋转指定角度的四元数       |
| Euler          | 构造指定欧拉角的四元数             |
| FromToRotation | 构造一个方向到另一方向的四元数     |
| LookRotation   | 构造指定前向矢量和上方矢量的四元数 |
|                |                                    |
| Dot            | 内积                               |
| Inverse        | 求逆                               |
| RotateTowards  | 从指定旋转量，旋转至另一旋转量     |
| Lerp           | 线性插值                           |
| Slerp          | 球面差值                           |
| ToEulerAngles  | 转换成欧拉角的表达形式             |
| ToAngleAxis    | 转换成角度和旋转角的表达形式       |







### 矩阵

矩阵通常在图形学中用作变换。一个3D空间的矢量(x,y,z) · M之后，得到的结果必须是(x',y',z')这样的3D空间矢量，此时，将(x,y,z)当做1x3矩阵，按照矩阵乘法规则，M应该是3x3矩阵。

图形变换矩阵通常融合了缩放、旋转、平移三种矩阵，以及切变矩阵。

#### 缩放矩阵

当表示缩放时，(x,y,z) * (a,b,c) => (ax, by, cz)。对应的矩阵应为：

> M = |a,0,0|
>
> ​	|0,b,0|
>
> ​	|0,0,c|

#### 平移矩阵

当表示平移时，(x,y,z) + (t,u,v) = (x + t, y + u, z + v),对应的矩阵应为：



#### 旋转矩阵

当表示旋转时，如V:(x,y) 绕θ角度旋转，其实是绕z轴旋转，其表达式为：

x' = x * cos(α + θ), y' = y * sin(α + θ), 而x = |V| * cos(α), y = |V| * sin(α)

按照三角学变换：

cos(α + θ) = cosα * cosθ - sinα * sinθ

sin(α + θ) = cosα * sinθ + sinα * cosθ 

转换成矩阵：

> M = | cosθ, sinθ|
>
> ​	|sinθ, cosθ|

即： (x,y) * M = (x * cosθ - y * sinθ, x * sinθ + y * cosθ)

旋转矩阵的核心，即：绕固定轴进行旋转，其结果相当于分别以坐标系的三个轴：x,y,z为旋转轴的旋转的叠加。所以，旋转矩阵其计算方式，仍然是欧拉角计算方式。但表示形式有所不同。

对于在2D空间中的(x,y),都可表示为(n * cosθ,n * sinθ)，其中n表示矢量的大小|(x,y)|。对于3D空间中，

#### 矩阵运算：

加法，减法，数乘，转置，共轭，共轭转置。

矩阵乘法： 

> m = |a  	b|		n = | e	f|
>
> ​	|c	d|		       | g	h|

> m * n = | a * e + b * g 	$$

#### 矩阵常见操作：

| 操作或数值                  | 用途或意义                                                   |
| --------------------------- | ------------------------------------------------------------ |
| zero                        | 所有元素都为0的矩阵                                          |
| identity                    | 单位矩阵，如同数的乘法中的1。主对角线元素均为1，除此之外全是0. |
| determinant                 | 矩阵行列式：\|\|a,b\|,\|c,d\|\| = ad - bc . [3维矢量行列式](file://3维矩阵行列式.svg) |
| inverse                     | 逆矩阵。？？？                                               |
| transpose                   | 矩阵转置                                                     |
| rotation                    | 矩阵所包含的旋转信息                                         |
|                             |                                                              |
| LookAt                      |                                                              |
| Ortho                       |                                                              |
| Perspective                 |                                                              |
| Rotate                      |                                                              |
| Scale                       |                                                              |
| Translate                   |                                                              |
| TRS(TranslateRotationScale) |                                                              |
|                             |                                                              |
| 与点相乘                    | 变换点的位置                                                 |
| 与方向相乘                  | 变换方向                                                     |

